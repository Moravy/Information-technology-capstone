# 2018_Group_14
158.383 Information Technology Project

## Description
OpenStreetMap (OSM) is a collaborative project to create a free editable map of the world. Rather than the map itself, the data generated by the project is considered its primary output. The creation and growth of OSM has been motivated by restrictions on use or availability of map information across much of the world, and the advent of inexpensive portable satellite navigation devices. OSM is considered a prominent example of volunteered geographic information.

## Assignment 1 - Task One

### Usage

#### System required
AWS Instance - .NET Core 2.1 with Ubuntu Server 18.04 - Version 1.0  
Storage: 30GB  
* Our system does not require .NET support. So, although this system has prebuilt .NET Core, it still can be seen as a blank instance. We just need Ubuntu Server 18.04

#### Sercurity groups
> HTTP 			TCP 	80 		0.0.0.0/0  
> PostgreSQL 	TCP		5432	0.0.0.0/0  
> SSH			TCP		22		0.0.0.0/0  
> http 			TCP		443		0.0.0.0/0  

To install OpenStreetMap by default settings, run:  
> curl https://raw.githubusercontent.com/Damming/MapData/master/set_up_OpenStreetMap.sh | bash

To install OpenStreetMap with your own password, run:  
> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/set_up_OpenStreetMap_with_password.sh) your_password

For example, if your password is 12345678, then run:  
> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/set_up_OpenStreetMap_with_password.sh) 12345678

* The installation process might be stuck by very a little warnings or some steps need times, those are all normal.

### Test

OpenStreetMap server is ready when you see these lines (the numbers may different)  
> renderd[12266]: Starting stats thread  
> renderd[12266]: Using web mercator projection settings  
> renderd[12266]: Using web mercator projection settings  
> renderd[12266]: Using web mercator projection settings  
> renderd[12266]: Using web mercator projection settings  

Then open http://actual_ip/osm_tiles/0/0/0.png to see if tiles can be rendered (you can change the values of /0/0/0.png they are scale, x, y respectivly)  
or  
http://autual_ip/ol.html to see the relinked online map  

If you want to see if the password is correctly set, press Control+C to interupt the server process, then enter 'cd ~' to go back to the user root directory, then enter 'vi .pgpass'. Then you will see your password after the last colon.


## Assignment 1 - Task Two

### Discussion: Use of Management and Staging Environments
In task one we successfully set up a working OpenStreetMap server that will act as our management server for task two. We will use our management server to create duplicate OSM servers.

These duplicate copies of OSM can be used as staging environments with the same hardware and software settings for testing and evaluating changes privately. By having staging environments that are identical or as close as possible to our production environment, we can minimise differences which may cause or hide issues in the deployment of changes. As developers we want to minimise the risk of errors being transitioned to our live environments and ensure minimal downtime. 

Staging environments allow us to ensure there are no conflicts before making changes live. New duplicates of our original production environment can be made quickly should there be issues caused by changes in another staging environment. 

### Usage
#### Install ansible
* If you are going to rerun the playbook, please delete the created keypair in AWS console.   

Run prepared_localhost.sh. This Shell Script will install Ansible and Boto in the current system. Then, a Ansible playbook used to create a new AWS KeyPair will be created. The new KeyPair is ~/.ssh/keypairForAnsible.yem.  
Parameters are aws_access_key_id, aws_secret_access_key, region.   

* Please have a look at the 'IMPORTANT' below first!   

> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/prepared_localhost.sh) aws_access_key_id aws_secret_access_key region  

For example your aws_access_key_id is 'aaaa' and your aws_secret_access_key is 'bbbb' and you want to create the new instance in us-west-2, then run:  
> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/prepared_localhost.sh) aaaa bbbb us-west-2  

#### Run playbook
* IMPORTANT - If you did not create instance in us-west-2, then you need to change the value of image (line 33) and reigon (line 35) before run the script. A feasible way is to edit the file directly in Github page and then click raw, use the address replace the address below.

> wget -c https://raw.githubusercontent.com/Damming/MapData/master/prepared_new_instance.yml | ansible-playbook prepared_new_instance.yml

### Test
http://autual_ip/ol.html  

## Assignment 2 - Task One

### Decrisption

In this task, six AWS instances are required. They are 1 assistant server, 1 database server, 3 OpenStreetMap program servers (including 1 backup), and 1 nginx server. Only assistant server needs to be setup manually. The other servers can be setup by Ansible playbook running on the assistant server. Assistant server can also be used to update program server.

#### System required
Ubuntu Server 18.04 LTS (HVM)  
Assistant server needs 8G storage. The other servers' storage will be set by the playbook.

#### Sercurity groups (Assistant server)
> HTTP 			TCP 	80 		0.0.0.0/0  
> PostgreSQL 	TCP		5432	0.0.0.0/0  
> SSH			TCP		22		0.0.0.0/0  
> http 			TCP		443		0.0.0.0/0  
The other server will be set by the playbook.

### Usage
* Please have a look at the usage of Assignment 1 - Task 2 first.  

#### Setup system
Setup an assistant server, then run:
> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/ansible.sh) aws_access_key_id aws_secret_access_key region  

The shell script you just ran has installed Ansible into assistant server. Next step is setup all the other servers. Run:
> wget -c https://raw.githubusercontent.com/Damming/MapData/master/Q2_playbook.yml | ansible-playbook Q2_playbook.yml

This playbook will run quiet a while. The system will be ready for using after the playbook is running completely.

#### Update
If you want to update all the program servers in one time, run:
> wget -c https://raw.githubusercontent.com/Damming/MapData/master/update.yml | ansible-playbook update.yml

If you want to update servers one at a time and see the changes, download the update playbook by:
> wget -c https://raw.githubusercontent.com/Damming/MapData/master/update.yml

Then comment the 26th line and decomment the 27th line. The '0' in the 27th line is used to control which server is going to be updated. The valid options are 0, 1, 2. Run the following command to execute the playbook:
> ansible-playbook update.yml

### Test
http://autual_ip_of_nginx_server/ol.html  
If you only updated one program server. The old version and the new version will appear alternately.  
The log of nginx can be found in /var/log/nginx/

## Assignment 2 - Task Two

### Decrisption
Backup and restore the database.

### Usage
Setup a blank backup server, then run:
> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/backup.sh) actual_database_ip  

Now, the backup server will backup the database every 15 minutes. You can modify the last line of /etc/crontab to change the backup rate.  

Then, delete the database server instance and run the following command on backup server:
> bash <(curl -s https://raw.githubusercontent.com/Damming/MapData/master/restore.sh) retore_database_ip  
We highly recommand you just use localhost as the place to restore the database, otherwise you need to set up a blank database server first, which is a bit complex.  

Last, reconfigure the map program servers, download configure playbook:  
> wget -c https://raw.githubusercontent.com/Damming/MapData/master/change_database.yml  

Modify database ip in line 35, then run:  

> ansible-playbook change_database.yml  

### Test
http://autual_ip_of_nginx_server/ol.html  
